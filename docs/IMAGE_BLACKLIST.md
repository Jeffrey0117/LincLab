# åœ–ç‰‡é»‘åå–®ç³»çµ±

## æ¦‚è¿°

åœ–ç‰‡é»‘åå–®ç³»çµ±ç”¨æ–¼è‡ªå‹•éæ¿¾å’Œåˆªé™¤åŒ…å«ç‰¹å®šåœ–ç‰‡çš„è‰ç¨¿ã€‚è©²ç³»çµ±æ”¯æ´å¤šç¨®æ“ä½œæ–¹å¼ï¼ŒåŒ…æ‹¬ Web UIã€API ç«¯é»å’Œ CLI è…³æœ¬ã€‚

## æ¶æ§‹è¨­è¨ˆ

### 1. æ ¸å¿ƒçµ„ä»¶

#### é»‘åå–®é…ç½® (`src/lib/image-blacklist.ts`)

- **IMAGE_BLACKLIST**: é»‘åå–®é…ç½®é™£åˆ—
- **normalizeImgurUrl()**: æ­£è¦åŒ– imgur URL
- **isBlacklistedImage()**: æª¢æŸ¥å–®ä¸€ URL æ˜¯å¦åœ¨é»‘åå–®ä¸­
- **draftContainsBlacklistedImage()**: æª¢æŸ¥è‰ç¨¿æ˜¯å¦åŒ…å«é»‘åå–®åœ–ç‰‡
- **findBlacklistedImages()**: æ‰¾å‡ºè‰ç¨¿ä¸­æ‰€æœ‰é»‘åå–®åœ–ç‰‡

### 2. URL åŒ¹é…æ©Ÿåˆ¶

ç³»çµ±æ”¯æ´å¤šç¨® imgur URL æ ¼å¼ï¼š

```
https://imgur.com/e8dN5uA
https://i.imgur.com/e8dN5uA.jpg
https://i.imgur.com/e8dN5uA.png
http://imgur.com/e8dN5uA
```

æ‰€æœ‰ URL éƒ½æœƒè¢«æ­£è¦åŒ–ç‚ºçµ±ä¸€çš„ ID æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š`e8dN5uA`ï¼‰é€²è¡ŒåŒ¹é…ã€‚

### 3. æª¢æŸ¥ç¯„åœ

ç³»çµ±æœƒæª¢æŸ¥è‰ç¨¿ä¸­çš„ä»¥ä¸‹æ¬„ä½ï¼š

- `og_image`: OG åœ–ç‰‡ URL
- `template_config.imageUrl`: æ¨¡æ¿åœ–ç‰‡ URL
- `template_config.images[]`: æ¨¡æ¿åœ–ç‰‡é™£åˆ—

## ä½¿ç”¨æ–¹å¼

### æ–¹æ³• 1: Web UIï¼ˆæ¨è–¦ï¼‰

è¨ªå•ç®¡ç†é é¢ï¼š`/admin/blacklist`

åŠŸèƒ½ï¼š
- è‡ªå‹•æƒææ‰€æœ‰åŒ…å«é»‘åå–®åœ–ç‰‡çš„è‰ç¨¿
- é è¦½å¾…åˆªé™¤çš„è‰ç¨¿
- é¸æ“‡æ€§åˆªé™¤ï¼ˆå¯å–®é¸æˆ–å¤šé¸ï¼‰
- æŸ¥çœ‹åˆªé™¤çµæœå’ŒéŒ¯èª¤å ±å‘Š

æ“ä½œæ­¥é©Ÿï¼š
1. è¨ªå• `/admin/blacklist`
2. ç³»çµ±è‡ªå‹•æƒæä¸¦é¡¯ç¤ºçµæœ
3. å‹¾é¸è¦åˆªé™¤çš„è‰ç¨¿ï¼ˆé è¨­å…¨é¸ï¼‰
4. é»æ“Šã€Œåˆªé™¤é¸ä¸­çš„è‰ç¨¿ã€
5. ç¢ºèªåˆªé™¤æ“ä½œ
6. æŸ¥çœ‹åˆªé™¤çµæœ

### æ–¹æ³• 2: API ç«¯é»

#### é è¦½æ¨¡å¼ï¼ˆGETï¼‰

```bash
GET /api/automation/drafts/filter-blacklist
```

å›æ‡‰ç¯„ä¾‹ï¼š
```json
{
  "total": 5,
  "drafts": [
    {
      "id": "uuid",
      "shortCode": "abc123",
      "title": "è‰ç¨¿æ¨™é¡Œ",
      "ogTitle": "OG æ¨™é¡Œ",
      "ogDescription": "æè¿°",
      "blacklistedImages": [
        "https://imgur.com/e8dN5uA"
      ],
      "createdAt": "2025-11-21T00:00:00Z"
    }
  ],
  "message": "Found 5 drafts containing blacklisted images"
}
```

#### åŸ·è¡Œåˆªé™¤ï¼ˆPOSTï¼‰

```bash
POST /api/automation/drafts/filter-blacklist
Content-Type: application/json

{
  "confirm": true,
  "draftIds": ["uuid1", "uuid2"]  // å¯é¸ï¼Œä¸æä¾›å‰‡åˆªé™¤æ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„è‰ç¨¿
}
```

å›æ‡‰ç¯„ä¾‹ï¼š
```json
{
  "success": true,
  "deleted": 5,
  "failed": 0,
  "total": 5,
  "deletedDrafts": [...],
  "message": "Successfully deleted 5 out of 5 drafts"
}
```

### æ–¹æ³• 3: CLI è…³æœ¬

#### é è¦½æ¨¡å¼

```bash
npx tsx scripts/delete-blacklisted-drafts.ts --preview
```

è¼¸å‡ºï¼š
```
============================================================
åˆªé™¤åŒ…å«é»‘åå–®åœ–ç‰‡çš„è‰ç¨¿
============================================================

ğŸ“‹ ç•¶å‰é»‘åå–®ï¼š
   - e8dN5uA (ç‰¹å®šçš„ imgur åœ–ç‰‡ ID)

ğŸ” æƒæè‰ç¨¿ä¸­...
âœ“ æ‰¾åˆ° 100 å€‹è‰ç¨¿

âš ï¸  æ‰¾åˆ° 5 å€‹åŒ…å«é»‘åå–®åœ–ç‰‡çš„è‰ç¨¿ï¼š

1. è‰ç¨¿æ¨™é¡Œ
   çŸ­é€£çµï¼šabc123
   IDï¼šuuid
   å»ºç«‹æ™‚é–“ï¼š2025/11/21 ä¸Šåˆ12:00:00
   é»‘åå–®åœ–ç‰‡ (1)ï¼š
      - https://imgur.com/e8dN5uA

ğŸ“Œ é€™æ˜¯é è¦½æ¨¡å¼ï¼ŒæœªåŸ·è¡Œåˆªé™¤æ“ä½œ
```

#### åŸ·è¡Œåˆªé™¤

```bash
npx tsx scripts/delete-blacklisted-drafts.ts --delete
```

ç³»çµ±æœƒè¦æ±‚ç¢ºèªå¾ŒåŸ·è¡Œåˆªé™¤ã€‚

#### è‡ªå‹•åŒ–æ¨¡å¼ï¼ˆè·³éç¢ºèªï¼‰

```bash
AUTO_CONFIRM=true npx tsx scripts/delete-blacklisted-drafts.ts --delete
```

## æ–°å¢é»‘åå–®é …ç›®

ç·¨è¼¯ `src/lib/image-blacklist.ts`ï¼š

```typescript
export const IMAGE_BLACKLIST: BlacklistEntry[] = [
  {
    id: 'imgur-e8dN5uA',
    pattern: 'e8dN5uA',
    description: 'ç‰¹å®šçš„ imgur åœ–ç‰‡ ID',
    addedAt: '2025-11-21',
  },
  {
    id: 'imgur-NewBadImage',
    pattern: 'NewBadImage',
    description: 'æ–°å¢çš„é»‘åå–®åœ–ç‰‡',
    addedAt: '2025-11-22',
  },
  // åœ¨æ­¤æ·»åŠ æ›´å¤šé»‘åå–®é …ç›®
];
```

## å®‰å…¨æ€§è€ƒé‡

### 1. æ¬Šé™æ§åˆ¶

- API ç«¯é»éœ€è¦ç”¨æˆ¶èªè­‰
- åªèƒ½åˆªé™¤å±¬æ–¼ç•¶å‰ç”¨æˆ¶çš„è‰ç¨¿
- CLI è…³æœ¬ä½¿ç”¨ Service Role Keyï¼Œåƒ…é©ç”¨æ–¼å¾Œå°ç®¡ç†

### 2. åˆªé™¤ç¢ºèª

- Web UI è¦æ±‚äºŒæ¬¡ç¢ºèª
- API ç«¯é»è¦æ±‚ `confirm: true` åƒæ•¸
- CLI è…³æœ¬é è¨­è¦æ±‚æ‰‹å‹•ç¢ºèªï¼ˆé™¤éè¨­ç½® `AUTO_CONFIRM=true`ï¼‰

### 3. è³‡æ–™ä¿è­·

- åˆªé™¤è‰ç¨¿æ™‚ï¼Œ`scraped_items` è¨˜éŒ„æœƒä¿ç•™
- `created_link_id` æ¬„ä½è¨­ç‚º NULLï¼ˆON DELETE SET NULLï¼‰
- ä¿ç•™å»é‡è¨˜éŒ„ï¼Œé˜²æ­¢åŒä¸€å…§å®¹è¢«é‡è¤‡æŠ“å–

### 4. Dry-Run æ¨¡å¼

æ‰€æœ‰æ–¹æ³•éƒ½æ”¯æ´é è¦½æ¨¡å¼ï¼Œå¯ä»¥åœ¨åŸ·è¡Œåˆªé™¤å‰æŸ¥çœ‹å°‡è¢«åˆªé™¤çš„è‰ç¨¿ã€‚

## éŒ¯èª¤è™•ç†

### API ç«¯é»

- 400: ç¼ºå°‘å¿…è¦åƒæ•¸æˆ–åƒæ•¸ç„¡æ•ˆ
- 401: ç”¨æˆ¶æœªèªè­‰
- 500: å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤

æ‰€æœ‰éŒ¯èª¤éƒ½æœƒåŒ…å«è©³ç´°çš„éŒ¯èª¤è¨Šæ¯ã€‚

### CLI è…³æœ¬

- ç¼ºå°‘ç’°å¢ƒè®Šæ•¸æ™‚æœƒé¡¯ç¤ºéŒ¯èª¤ä¸¦é€€å‡º
- è³‡æ–™åº«éŒ¯èª¤æœƒé¡¯ç¤ºè©³ç´°è¨Šæ¯
- æ‰¹é‡åˆªé™¤æ™‚æœƒè¨˜éŒ„æ¯å€‹å¤±æ•—çš„é …ç›®

## æ¸¬è©¦

åŸ·è¡Œå–®å…ƒæ¸¬è©¦ï¼š

```bash
npm test -- image-blacklist.test.ts
```

æ¸¬è©¦è¦†è“‹ï¼š
- URL æ­£è¦åŒ–ï¼ˆå„ç¨® imgur æ ¼å¼ï¼‰
- é»‘åå–®åŒ¹é…ï¼ˆå¤§å°å¯«ã€å”è­°ã€æª”æ¡ˆå‰¯æª”åï¼‰
- è‰ç¨¿æª¢æŸ¥ï¼ˆog_image, template_configï¼‰
- é‚Šç•Œæƒ…æ³ï¼ˆç©ºå€¼ã€ç„¡æ•ˆ URLï¼‰

## ç›£æ§èˆ‡æ—¥èªŒ

### API ç«¯é»æ—¥èªŒ

```javascript
console.log(`âœ“ Deleted draft ${draft.short_code} (${draft.id}) containing blacklisted images`);
```

### CLI è…³æœ¬è¼¸å‡º

- æƒæé€²åº¦
- æ‰¾åˆ°çš„é»‘åå–®è‰ç¨¿è©³ç´°è³‡è¨Š
- åˆªé™¤æˆåŠŸ/å¤±æ•—çµ±è¨ˆ
- éŒ¯èª¤è¨Šæ¯

## æœ€ä½³å¯¦è¸

1. **å®šæœŸæƒæ**: å»ºè­°å®šæœŸåŸ·è¡Œé è¦½æ¨¡å¼æª¢æŸ¥æ–°çš„é•è¦è‰ç¨¿
2. **å‚™ä»½**: åœ¨å¤§é‡åˆªé™¤å‰è€ƒæ…®å‚™ä»½è³‡æ–™åº«
3. **æ¸¬è©¦ç’°å¢ƒ**: å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰é»‘åå–®è¦å‰‡
4. **æ–‡æª”æ›´æ–°**: æ–°å¢é»‘åå–®é …ç›®æ™‚æ›´æ–°æè¿°
5. **é€šçŸ¥æ©Ÿåˆ¶**: è€ƒæ…®åœ¨åˆªé™¤å¾Œç™¼é€é€šçŸ¥çµ¦ç›¸é—œäººå“¡

## æ“´å±•æ€§

### æ”¯æ´å…¶ä»–åœ–åºŠ

ä¿®æ”¹ `normalizeImgurUrl` å’Œ `isBlacklistedImage` å‡½æ•¸ä»¥æ”¯æ´å…¶ä»–åœ–åºŠï¼š

```typescript
export function normalizeImageUrl(url: string): string | null {
  // imgur
  const imgurId = normalizeImgurUrl(url);
  if (imgurId) return `imgur:${imgurId}`;

  // å…¶ä»–åœ–åºŠ
  // ...

  return null;
}
```

### å‹•æ…‹é»‘åå–®ï¼ˆè³‡æ–™åº«å­˜å„²ï¼‰

æœªä¾†å¯ä»¥å°‡é»‘åå–®å­˜å„²åœ¨è³‡æ–™åº«ä¸­ï¼Œæ”¯æ´å‹•æ…‹æ–°å¢/åˆªé™¤ï¼š

```sql
CREATE TABLE image_blacklist (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  pattern VARCHAR(255) NOT NULL,
  description TEXT,
  added_at TIMESTAMP DEFAULT NOW(),
  added_by UUID REFERENCES auth.users(id)
);
```

## æ•…éšœæ’é™¤

### å•é¡Œï¼šç„¡æ³•æ‰¾åˆ°é»‘åå–®åœ–ç‰‡

æª¢æŸ¥ï¼š
1. URL æ ¼å¼æ˜¯å¦æ­£ç¢º
2. é»‘åå–® pattern æ˜¯å¦æ­£ç¢º
3. åœ–ç‰‡ URL æ˜¯å¦åœ¨æª¢æŸ¥ç¯„åœå…§

### å•é¡Œï¼šåˆªé™¤å¤±æ•—

æª¢æŸ¥ï¼š
1. ç”¨æˆ¶æ¬Šé™æ˜¯å¦æ­£ç¢º
2. è‰ç¨¿æ˜¯å¦å·²è¢«åˆªé™¤
3. è³‡æ–™åº«é€£ç·šæ˜¯å¦æ­£å¸¸
4. æŸ¥çœ‹è©³ç´°éŒ¯èª¤è¨Šæ¯

### å•é¡Œï¼šæ€§èƒ½å•é¡Œ

å„ªåŒ–å»ºè­°ï¼š
1. æ‰¹æ¬¡å¤§å°é™åˆ¶ï¼ˆé¿å…ä¸€æ¬¡åˆªé™¤éå¤šï¼‰
2. æ–°å¢è³‡æ–™åº«ç´¢å¼•
3. ä½¿ç”¨è³‡æ–™åº«å‡½æ•¸æ‰¹é‡æ“ä½œ

## ç›¸é—œæ–‡ä»¶

- [è‰ç¨¿å¯©æ ¸ç³»çµ±](./AUTOMATION_SYSTEM.md)
- [API æ–‡æª”](../src/app/api-docs/page.tsx)
- [è³‡æ–™åº« Schema](../supabase/migrations/20251114000001_add_link_status_and_dedup.sql)
